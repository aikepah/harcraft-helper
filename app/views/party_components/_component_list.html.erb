</table>
<div class="mt-4">
  <%= paginate @components, params: request.query_parameters.except(:page) %>
</div>
<div data-controller="modal">
  <div class="mb-6">
    <h2 class="font-bold text-xl mb-2">Available Components</h2>
    <div class="flex gap-4 mb-4">
      <%= form_with url: new_party_party_component_path(@party), method: :get, local: true, class: 'flex gap-2' do %>
        <%= select_tag :monster_type, options_for_select(@monster_types, @selected_monster_type), prompt: 'Filter by Monster Type', class: 'rounded border px-2 py-1', onchange: 'this.form.submit()' %>
        <%= select_tag :component_type, options_for_select(@component_types, @selected_component_type), prompt: 'Filter by Component Type', class: 'rounded border px-2 py-1', onchange: 'this.form.submit()' %>
      <% end %>
    </div>

    <div class="text-sm text-gray-600 mb-4">
      <strong>Legend:</strong>
      <sup class="text-green-600 font-bold">E</sup> = Edible,
      <sup class="text-red-600 font-bold">V</sup> = Volatile,
      ℹ️ = Has notes (hover to view)
    </div>

    <table class="min-w-full border">
      <thead>
        <tr>
          <th class="border px-2 py-1">Items</th>
          <th class="border px-2 py-1">Monster Type</th>
          <th class="border px-2 py-1">Component Type</th>
          <th class="border px-2 py-1">Harvest DC</th>
          <th class="border px-2 py-1">Harvesting Skills</th>
          <th class="border px-2 py-1">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @components.each do |component| %>
          <tr data-controller="expandable-row" data-expandable-row-component-id-value="<%= component.id %>">
            <td class="border px-2 py-1 flex items-center gap-2">
              <button
                type="button"
                class="expand-btn text-lg p-0 w-6 h-6 flex items-center justify-center bg-[#3F4045] text-[#FCFCFC] hover:bg-[#5D737E] hover:text-[#02111B] rounded transition focus:outline-none"
                aria-label="Expand row"
                data-action="click->expandable-row#toggle"
              >
                <span data-expandable-row-target="icon" aria-hidden="true">&#9654;</span>
              </button>
            </td>
            <td class="border px-2 py-1"><%= component.monster_type&.titleize %></td>
            <td class="border px-2 py-1">
              <%= component.component_type&.titleize %>
              <% if component.edible %><sup class="text-green-600 font-bold">E</sup><% end %>
              <% if component.volatile %><sup class="text-red-600 font-bold">V</sup><% end %>
              <% if component.note.present? %>
                <span class="ml-1 text-xs text-gray-500" title="<%= component.note %>">ℹ️</span>
              <% end %>
            </td>
            <td class="border px-2 py-1"><%= component.dc %></td>
            <td class="border px-2 py-1">
              <% harvesting_info = harvesting_info_for_component(component) %>
              <div class="text-sm">
                <div><strong>Assessment:</strong> <%= harvesting_info[:assessment_skill] %> (Int)</div>
                <div><strong>Carving:</strong> <%= harvesting_info[:assessment_skill] %> (Dex)</div>
                <% if harvesting_info[:ritual_carving_allowed] %>
                  <div class="text-green-600"><strong>Ritual Carving:</strong> Available</div>
                <% end %>
              </div>
            </td>
            <td class="border px-2 py-1">
              <button type="button" class="px-3 py-1 rounded bg-green-600 text-white font-semibold hover:bg-green-800 transition" data-action="click->modal#open" data-modal-component-id-value="<%= component.id %>">Add</button>
            </td>
          </tr>
          <tr id="craftable-items-<%= component.id %>" class="hidden">
            <td colspan="6" class="p-0 border-t-0">
              <%= render partial: "party_components/craftable_items_for_component", locals: { component: component } %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <!-- Modal for Add Form (Stimulus-powered) -->
  <div data-modal-component-id-value="" data-modal-target="dialog" id="add-form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded shadow-lg w-96 border border-gray-400">
      <h3 class="font-bold text-lg mb-4 text-gray-900">Add to Inventory</h3>
      <form action="<%= party_party_components_path(@party) %>" method="post" id="add-component-form">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
    <input type="hidden" name="party_component[component_id]" data-modal-target="componentId" />
        <div class="mb-4">
          <label for="modal_quantity" class="block mb-1 font-semibold text-gray-900">Quantity</label>
          <input type="number" name="party_component[quantity]" id="modal_quantity" min="1" value="1" class="w-full rounded border border-gray-400 px-2 py-1 text-gray-900 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" style="appearance: textfield;" />
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" data-action="click->modal#close" class="px-3 py-1 rounded bg-gray-200 text-gray-900 font-semibold border border-gray-400">Cancel</button>
          <button type="submit" class="px-3 py-1 rounded bg-blue-600 text-white font-semibold hover:bg-blue-800 transition border border-blue-700">Add</button>
        </div>
      </form>
    </div>
  </div>
